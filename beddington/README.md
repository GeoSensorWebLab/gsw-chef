# `beddington` cookbook

Cookbook for setting up a node with DokuWiki for ArcticConnect.

## Supported Platforms

* Ubuntu Server 20.04 LTS

## Usage

## Manual Pre-configuration

The setup of mounted volumes for the instance must be done manually, as there is no straight-forward way of doing this that is compatible with both OpenStack and Test-Kitchen (the local development environment). The reason is that the ID/UUID generated by the infrastructure cannot easily be matched to any volume serial number visible in the system. For OpenStack the volume ID is directly visible in the disk ID under `/dev/disk/by-id`, but in Test-Kitchen (running under VirtualBox) only *part* of the UUID is visible in that same directly.

A volume should already be created and mounted by either Terraform (in production) or Test-Kitchen (in testing). This volume will not be formatted with any filesystem, which must be done manually.

```
$ sudo apt update
$ sudo apt install zfsutils-linux
$ sudo ls -lh /dev/disk/by-id
... (find the raw disk volume in this list)
$ sudo zpool create -f -O compression=on storage /dev/disk/by-id/ata-VBOX_HARDDISK_VBf9addf63-22cf6881
$ sudo zpool list
NAME      SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
storage  9.50G   114K  9.50G        -         -     0%     0%  1.00x    ONLINE  -
```

The cookbook recipes will **fail** if a ZFS pool named `storage` is not available.

## `beddington::default` recipe

Installs ZFS for Linux, Docker, Docker Compose, and DokuWiki running under Docker. Running the "install.php" script for DokuWiki **is not** necessary.

A default `WikiAdmin` user will be created with a password from Chef Vault. SMTP credentials will be added from Chef Vault.

For DokuWiki, the following plugins are installed:

* [Display Orphans Plugin](https://www.dokuwiki.org/plugin:displayorphans)
* [Note Plugin](https://www.dokuwiki.org/plugin:note)
* [SMTP Plugin](https://www.dokuwiki.org/plugin:smtp)

If the Chef Vault is configured to enable Restic and/or HTML backups, then an automatic cron-based system to backup the wiki to S3 will be enabled.

**Please Note:** The recipe requires Chef vault items. See the "Chef Vault" section below for more details.

## Attributes

Attributes are documented in the `attributes` directory.

## Chef Vault

The following Chef Vault items are required for the recipes in this cookbook.

<table>
  <tr>
    <th>Key</th>
    <th>Type</th>
    <th>Description</th>
    <th>Default</th>
  </tr>
  <tr>
    <td><tt>secrets/beddington['id']</tt></td>
    <td>String</td>
    <td>Vault Item ID</td>
    <td><tt>beddington</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['html_backup_enabled']</tt></td>
    <td>Boolean</td>
    <td>Determines if static HTML backup system will be configured. Disabled for testing.</td>
    <td><tt>false</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['html_backup_s3_key']</tt></td>
    <td>String</td>
    <td>Path to S3 object where static HTML backup archive is stored.</td>
    <td><tt>s3://BUCKET_NAME_HERE/html-archives/htmlexport.tgz</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['restic_enabled']</tt></td>
    <td>Boolean</td>
    <td>Determines if Restic backup system will be configured. Disabled for testing.</td>
    <td><tt>false</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['AWS_ACCESS_KEY_ID']</tt></td>
    <td>String</td>
    <td>AWS Access Key ID for uploading Restic and HTML backups to S3.</td>
    <td><tt></tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['AWS_SECRET_ACCESS_KEY']</tt></td>
    <td>String</td>
    <td>AWS Secret Acces Key for uploading Restic and HTML backups to S3.</td>
    <td><tt></tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['AWS_DEFAULT_REGION']</tt></td>
    <td>String</td>
    <td>Region for uploading Restic and HTML backups to S3.</td>
    <td><tt>us-east-1</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['RESTIC_PASSWORD']</tt></td>
    <td>String</td>
    <td>Password for encrypting the Restic backups. Mandatory if Restic is enabled.</td>
    <td><tt></tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['RESTIC_REPOSITORY']</tt></td>
    <td>String</td>
    <td>Path to S3 key where Restic backup repository is stored.</td>
    <td><tt>s3:s3.amazonaws.com/BUCKET_NAME_HERE/BUCKET_KEY_HERE</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['wiki_user']</tt></td>
    <td>String</td>
    <td>Login username for DokuWiki for the user running static HTML backups. Should have read-only access.</td>
    <td><tt>wikibackup</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/beddington['wiki_password']</tt></td>
    <td>String</td>
    <td>Password for DokuWiki for the user running static HTML backups.</td>
    <td><tt></tt></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['id']</tt></td>
    <td>String</td>
    <td>Vault Item ID</td>
    <td><tt>dokuwiki</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['smtp_auth_user']</tt></td>
    <td>String</td>
    <td>Username for accessing SMTP server</td>
    <td></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['smtp_auth_pass']</tt></td>
    <td>String</td>
    <td>Password for accessing SMTP server</td>
    <td></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['users']</tt></td>
    <td>Array</td>
    <td>List of users for DokuWiki, each is a String inside this array. The string format is described in the next table item.</td>
    <td><tt>(empty)</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['users'][]</tt></td>
    <td>String</td>
    <td>String representation of user for DokuWiki. Format is <tt>login:passwordhash:Real Name:email:groups,comma,separated</tt>. "passwordhash" is the PHP BCrypt hash of the user's password.</td>
    <td></td>
  </tr>
</table>

Samples can be found in [`test/fixtures/data_bags/secrets/beddington.json`](test/fixtures/data_bags/secrets/beddington.json) and [`test/fixtures/data_bags/secrets/dokuwiki.json`](test/fixtures/data_bags/secrets/dokuwiki.json).

In the following example, a `secrets` vault is created/updated for a `dokuwiki` item, with a `smtp_auth_user`. It is only decryptable by the `beddington` client node OR by an admin named `jpbadger`. The client node and admin user would be defined in the Chef Infra Server.

```terminal
$ knife vault create secrets airflow '{"smtp_auth_user": "username"}' -C "beddington" -A "jpbadger"
```

(For local development usage in Test Kitchen, unencrypted data bags in `test/fixtures/data_bags/secrets` is used instead. The default `WikiAdmin` user's password is `howdy`.)

## License and Authors

James Badger (jpbadger@ucalgary.ca)
