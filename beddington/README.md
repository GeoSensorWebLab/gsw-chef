# `beddington` cookbook

Cookbook for setting up a node with DokuWiki for ArcticConnect.

## Supported Platforms

* Ubuntu Server 20.04 LTS

## Usage

## Manual Pre-configuration

The setup of mounted volumes for the instance must be done manually, as there is no straight-forward way of doing this that is compatible with both OpenStack and Test-Kitchen (the local development environment). The reason is that the ID/UUID generated by the infrastructure cannot easily be matched to any volume serial number visible in the system. For OpenStack the volume ID is directly visible in the disk ID under `/dev/disk/by-id`, but in Test-Kitchen (running under VirtualBox) only *part* of the UUID is visible in that same directly.

A volume should already be created and mounted by either Terraform (in production) or Test-Kitchen (in testing). This volume will not be formatted with any filesystem, which must be done manually.

```
$ sudo apt update
$ sudo apt install zfsutils-linux
$ sudo ls -lh /dev/disk/by-id
... (find the raw disk volume in this list)
$ sudo zpool create -f -O compression=on storage /dev/disk/by-id/ata-VBOX_HARDDISK_VBf9addf63-22cf6881
$ sudo zpool list
NAME      SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
storage  9.50G   114K  9.50G        -         -     0%     0%  1.00x    ONLINE  -
```

The cookbook recipes will **fail** if a ZFS pool named `storage` is not available.

## `beddington::default` recipe

Installs ZFS for Linux, Docker, Docker Compose, and DokuWiki running under Docker. Running the "install.php" script for DokuWiki **is not** necessary.

A default `WikiAdmin` user will be created with a password from Chef Vault. SMTP credentials will be added from Chef Vault.

For DokuWiki, the following plugins are installed:

* [Display Orphans Plugin](https://www.dokuwiki.org/plugin:displayorphans)
* [Note Plugin](https://www.dokuwiki.org/plugin:note)
* [SMTP Plugin](https://www.dokuwiki.org/plugin:smtp)

**Please Note:** The recipe requires a Chef vault item. See the "Chef Vault" section below for more details.

## Attributes

Attributes are documented in the `attributes` directory.

## Chef Vault

The following Chef Vault items are required for the recipes in this cookbook.

<table>
  <tr>
    <th>Key</th>
    <th>Type</th>
    <th>Description</th>
    <th>Default</th>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['id']</tt></td>
    <td>String</td>
    <td>Vault Item ID</td>
    <td><tt>dokuwiki</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['smtp_auth_user']</tt></td>
    <td>String</td>
    <td>Username for accessing SMTP server</td>
    <td></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['smtp_auth_pass']</tt></td>
    <td>String</td>
    <td>Password for accessing SMTP server</td>
    <td></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['users']</tt></td>
    <td>Array</td>
    <td>List of users for DokuWiki, each is a String inside this array. The string format is described in the next table item.</td>
    <td><tt>(empty)</tt></td>
  </tr>
  <tr>
    <td><tt>secrets/dokuwiki['users'][]</tt></td>
    <td>String</td>
    <td>String representation of user for DokuWiki. Format is <tt>login:passwordhash:Real Name:email:groups,comma,separated</tt>. "passwordhash" is the PHP BCrypt hash of the user's password.</td>
    <td></td>
  </tr>
</table>

In the following example, a `secrets` vault is created/updated for a `dokuwiki` item, with a `smtp_auth_user`. It is only decryptable by the `beddington` client node OR by an admin named `jpbadger`. The client node and admin user would be defined in the Chef Infra Server.

```terminal
$ knife vault create secrets airflow '{"smtp_auth_user": "username"}' -C "beddington" -A "jpbadger"
```

(For local development usage in Test Kitchen, an unencrypted data bag in `test/fixtures/data_bags/secrets` is used instead. The default password is "howdy".)

## License and Authors

James Badger (jpbadger@ucalgary.ca)
